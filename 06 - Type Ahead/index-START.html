<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Type Ahead ğŸ‘€</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="https://fav.farm/ğŸ”¥" />
</head>

<body>

  <form class="search-form">
    <input type="text" class="search" placeholder="City or State">
    <ul class="suggestions">
      <li>Filter for a city</li>
      <li>or a state</li>
    </ul>
  </form>
  <script>
    const endpoint = 'https://gist.githubusercontent.com/Miserlou/c5cd8364bf9b2420bb29/raw/2bf258763cdddd704f8ffd3ea9a3e81d25e2c6f6/cities.json';

    const suggestions = document.querySelector('.suggestions')
    const searchInput = document.querySelector('.search')
    let cityList = []

    async function getEndpointData() {
      const response = await fetch(endpoint)
      const data = await response.json()
      return data
    }

    function renderFilterCityList() {
      const currentStr = searchInput.value;
      const regexp = new RegExp(currentStr, 'gi')

      while (suggestions.firstChild) {
        suggestions.removeChild(suggestions.firstChild)
      }


      /* ä¿®æ­£1. é€™é‚Šå¯ä»¥æŠ½å‡ºä¸€å€‹ findMatches å¯ä»¥ä¹‹å¾Œå…±ç”¨ï¼Œä¸”æ›´æ¸…æ™°
      function findMatches(wordToMatch, cities) {
        return cities.filter(place => {
          // here we need to figure out if the city or state matches what was searched
          const regex = new RegExp(wordToMatch, 'gi');
          return place.city.match(regex) || place.state.match(regex)
        });
      }
      */
      const filterCityList = cityList.filter(cityInfo => regexp.test(cityInfo.city) || regexp.test(cityInfo.state))

      /* ä¿®æ­£2. é€™é‚Šæ˜¯åœ¨å°å¾Œé¢æ•¸å­—åšä½æ•¸çš„é€—è™Ÿï¼Œæˆ‘æ²’è£œä¸Šå»å°±ä¸åŠ äº†
      function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }
      */

      /* ä¿®æ­£3. æˆ‘è‡ªå·±éƒ½ç”¨åˆ°ä¿®æ”¹ innerHTML äº†ï¼Œæ‡‰è©²å°±ä¸ç”¨å»è·‘ç„¡è¬‚çš„ while(suggestions.firstChild) å»ä¸€å€‹ä¸€å€‹åˆªé™¤äº†ï¼Œç›´æ¥æ•´å€‹ HTML æ›æ‰å³å¯
      
      function displayMatches() {
        const matchArray = findMatches(this.value, cities);
        const html = matchArray.map(place => {
          const regex = new RegExp(this.value, 'gi');
          const cityName = place.city.replace(regex, `<span class="hl">${this.value}</span>`);
          const stateName = place.state.replace(regex, `<span class="hl">${this.value}</span>`);
          return `
            <li>
              <span class="name">${cityName}, ${stateName}</span>
              <span class="population">${numberWithCommas(place.population)}</span>
            </li>
          `;
        }).join('');
        suggestions.innerHTML = html;
      }
      */
      filterCityList.forEach(i => {
        const li = document.createElement('li')
        const p = document.createElement('p')
        const population = document.createElement('p')

        const content = i.city + ', ' + i.state
        const highlightContent = content.replace(regexp, prev => `<mark class='hl'>${prev}</mark>`)

        p.innerHTML = highlightContent
        population.innerHTML = i.population

        li.append(p, population)
        suggestions.append(li)
      })
    }

    // å¦‚æœä½¿ç”¨åŒ¿åå‡½å¼ä¸è¦ç”¨ this ä¾†å»æ‹¿
    async function handleFilterRender() {
      if (!cityList.length) {
        cityList = await getEndpointData()
      }

      renderFilterCityList()
    }

    searchInput.addEventListener('input', handleFilterRender)


  </script>
</body>

</html>